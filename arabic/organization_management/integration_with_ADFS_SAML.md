# تكامل مع ADFS/SAML لتسجيل الدخول الموحد

**ملاحظة**: يمكن إجراء العمليات التالية فقط بواسطة مسؤولي المؤسسة.

تختلف الخطوات التفصيلية اعتمادًا على خدمة ADFS التي تستخدمها. نقدم خطوات التكامل لتسجيل الدخول الموحد باستخدام Azure SAML و ADFS على الشبكة المحلية.

## التكامل مع تطبيق Microsoft Azure SAML لتسجيل الدخول الموحد

إذا كنت تستخدم تطبيق Microsoft Azure SAML لتحقيق تسجيل الدخول الموحد، يرجى اتباع الخطوات التالية:

**أولاً**، أضف تطبيق SAML وقم بتعيين المستخدمين، يرجى الاطلاع على الروابط التالية: [إضافة تطبيق Azure AD SAML](https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/add-application-portal)، [إنشاء وتعيين المستخدمين](https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/add-application-portal-assign-users)

**ثانياً**، قم بإعداد عنوان URL لتسجيل الدخول الخاص بك في واجهة إدارة المؤسسة في Zaindrive. صيغة عنوان URL تسجيل الدخول هي: https://example.com/org/custom/{custom-part}/، على سبيل المثال:

![](../images/auto-upload/8c1988cd-1f66-47c9-ac61-650e8245efcf.png)

**ثم**، قم بإعداد "Identifier" و "Reply URL" و "Sign on URL" و "Logout Url" لتطبيق SAML الخاص بك بناءً على عنوان URL تسجيل الدخول الخاص بك، يرجى الاطلاع على الروابط التالية: [تمكين تسجيل الدخول الموحد لتطبيق SAML](https://learn.microsoft.com/en-us/azure/active-directory/manage-apps/add-application-portal-setup-sso). صيغة "Identifier" و "Reply URL" و "Sign on URL" هي: https://example.com/org/custom/{custom-part}/saml2/metadata/، https://example.com/org/custom/{custom-part}/saml2/acs/، https://example.com/org/custom/{custom-part}/، https://example.com/org/custom/{custom-part}/ls/، على سبيل المثال:

![](../images/auto-upload/2a6bdc13-88f8-418b-90e3-cba0a67b12e7

.png)

__ملاحظة__: يجب أن يحتوي الجزء المخصص "{custom-part}" من عنوان URL على 6 إلى 20 حرفًا، ويمكن أن يحتوي فقط على أحرف أبجدية رقمية وعلامات الشرطة.

**المقبل**، انسخ عنوان URL للتطبيق SAML:

![](../images/auto-upload/6702c7c7-a205-4b18-91d2-48dd1a1b7b03.png)

والصقه في واجهة إدارة المؤسسة، على سبيل المثال:

![](../images/auto-upload/d2252310-0c30-4d88-a553-5711820a65df.png)

**المقبل**، قم بتنزيل شهادة تطبيق SAML بتنسيق base64 وقم بإعادة تسميتها إلى idp.crt:

![](../images/auto-upload/3aa0b19d-46ac-426e-adcc-b3869b0a95a1.png)

ثم قم بتحميل idp.crt في واجهة إدارة المؤسسة:

![](../images/auto-upload/5b3ff455-de3f-4585-93d2-8ecc1c7cc0ea.png)

**المقبل**، [حرر السمات والمطالبات SAML](https://learn.microsoft.com/en-us/azure/active-directory/develop/saml-claims-customization). قم بترك السمات والمطالبات الافتراضية لتطبيق SAML بدون تغيير، يجب إضافة سمة "uid"، ويمكن اختيار إضافة السمات "mail" و "name" اختياريًا، على سبيل المثال:

![](../images/auto-upload/abee9c69-f03d-4735-9231-92bd923b9ceb.png)

**أخيرًا**، افتح المتصفح وانتقل إلى صفحة تسجيل الدخول في Zaindrive، انقر على "تسجيل الدخول الموحد"، على سبيل المثال:

![](../images/auto-upload/d88fd998-1382-4b1f-901b-60bb5d874c6e.png)

في الصفحة الجديدة، أدخل عنوان بريدك الإلكتروني المنتهي بالنطاق الخاص بالشركة، على سبيل المثال:

![](../images/auto-upload/bfd4a31c-2533-435d-9231-7f187117a139.png)

سيتم الانتقال إلى صفحة تسجيل الدخول لتطبيق S

AML عند النقر على زر "تسجيل الدخول"، على سبيل المثال:

![](../images/auto-upload/21dc07ae-89a7-4281-be18-566a64bca922.png)

## التكامل مع ADFS على الموقع

إذا كنت تستخدم Microsoft ADFS لتحقيق تسجيل الدخول الموحد، فيرجى اتباع الخطوات التالية:

**أولاً**، يُرجى التأكد من أن الإعدادات التالية قد تمت:

1. وجود خادم Windows مع [ADFS](https://learn.microsoft.com/en-us/windows-server/identity/active-directory-federation-services) مثبت. لتكوين وتثبيت ADFS، يمكنك الاطلاع على [هذه المقالة](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/deployment/deploying-a-federation-server-farm).

2. وجود شهادة SSL صالحة لخادم ADFS، وهنا سنستخدم `temp.adfs.com` كمثال لاسم النطاق.

3. وجود شهادة SSL صالحة لخادم Zaindrive، وهنا سنستخدم `demo.Zaindrive.com` كمثال لاسم النطاق.

**ثانيًا**، قم بإعداد عنوان URL لتسجيل الدخول إلى ADFS في واجهة إدارة المؤسسة Zaindrive. يكون تنسيق عنوان URL لتسجيل الدخول على النحو التالي: `https://example.com/org/custom/{custom-part}/`، على سبيل المثال:

![](../images/auto-upload/8c1988cd-1f66-47c9-ac61-650e8245efcf.png)

**المقبل**، قم بإعداد عنوان URL لملف البيانات الخاص بالتوحيد الفيدرالي لـ Microsoft ADFS في واجهة إدارة المؤسسة. يكون تنسيق عنوان URL لملف البيانات الخاص بالتوحيد الفيدرالي على النحو التالي: `https://{your ADFS domain name}/federationmetadata/2007-06/federationmetadata.xml`، على سبيل المثال:

![](../images/auto-upload/bde53e1b-dfef-4693-bba8-8ec8801627d6.png)

**المقبل**، قم بتنزيل الشهادة بتنسيق base64 وقم بتحميلها:

* انتقل إلى نافذة إدارة _AD FS_. في قائمة الشريط الجانبي الأيسر،

 انقر بزر الماوس الأيمن على الخادم _AD FS_ وحدد "إدارة الشهادات". انتقل إلى التبويب "شهادات الثقة" وحدد "شهادات الخادم"، ثم انقر بزر الماوس الأيمن على شهادة _SSL_ الخاصة بك وحدد "عرض تفاصيل الشهادة".

* في نافذة "تفاصيل الشهادة"، انتقل إلى التبويب "التفاصيل" وحدد "نسخ إلى ملف".

* في معالج "نسخ إلى ملف"، قم باختيار "X.509 Base-64 encoded" كتنسيق، ثم انقر فوق "التالي". قم بتحديد المسار واسم الملف، على سبيل المثال "C:\adfs.cer"، ثم انقر فوق "التالي" وأخيرًا "إنهاء".

* في نافذة إدارة _AD FS_, انتقل إلى قائمة الشريط الجانبي الأيسر، انقر بزر الماوس الأيمن على الخادم _AD FS_ وحدد "إدارة الشهادات". انتقل إلى التبويب "شهادات الثقة" وحدد "شهادات الخادم". انقر فوق "استيراد شهادة الخادم" في قائمة الأدوات.

* في معالج "استيراد شهادة الخادم"، انقر فوق "استعراض" وحدد المسار واسم الملف الذي قمت بتنزيله (على سبيل المثال "C:\adfs.cer")، ثم انقر فوق "التالي". انقر فوق "التالي" وأخيرًا "إنهاء".

**المقبل**، قم بتنزيل الشهادة العامة لـ _AD FS_ في تنسيق base64 وقم بتحميلها:

* انتقل إلى نافذة إدارة _AD FS_. في قائمة الشريط الجانبي الأيسر، انقر بزر الماوس الأيمن على الخادم _AD FS_ وحدد "إدارة الشهادات". انتقل إلى التبويب "شهادات الثقة" وحدد "شهادات الخادم"، ثم انقر بزر الماوس الأيمن على

 شهادة الخادم _AD FS_ الخاصة بك وحدد "عرض تفاصيل الشهادة".

* في نافذة "تفاصيل الشهادة"، انتقل إلى التبويب "التفاصيل" وحدد "نسخ إلى ملف".

* في معالج "نسخ إلى ملف"، قم باختيار "X.509 Base-64 encoded" كتنسيق، ثم انقر فوق "التالي". قم بتحديد المسار واسم الملف، على سبيل المثال "C:\adfs-public.cer"، ثم انقر فوق "التالي" وأخيرًا "إنهاء".

* في نافذة إدارة _AD FS_, انتقل إلى قائمة الشريط الجانبي الأيسر، انقر بزر الماوس الأيمن على الخادم _AD FS_ وحدد "إدارة الشهادات". انتقل إلى التبويب "شهادات الثقة" وحدد "شهادات الخادم". انقر فوق "استيراد شهادة ثقة" في قائمة الأدوات.

* في معالج "استيراد شهادة ثقة"، انقر فوق "استعراض" وحدد المسار واسم الملف الذي قمت بتنزيله (على سبيل المثال "C:\adfs-public.cer")، ثم انقر فوق "التالي". انقر فوق "التالي" وأخيرًا "إنهاء".

**المقبل**، احتفظ بملفي الشهادة `adfs.cer` و `adfs-public.cer` بأمان، سنحتاج إليهم في الخطوات التالية.

**المقبل**، قم بإعداد تطبيق Relying Party Trust في _AD FS_:

* في نافذة إدارة _AD FS_, في قائمة الشريط الجانبي الأيسر، انقر بزر الماوس الأيمن على "الثقة الواردة" وحدد "إضافة ثقة واردة".

* في معالج "إضافة ثقة واردة"، قم بتحديد "ابدأ" وانقر فوق "التالي".

* في الصفحة "تحديد نوع الثقة الواردة"، قم بتحديد "ثقة واردة من المعرّف الموحد للأداء (SAML)"

 وانقر فوق "التالي".

* في صفحة "إعدادات الاسم والعنوان"، قم بإدخال اسم للثقة الواردة، على سبيل المثال "Zaindrive"، ثم انقر فوق "التالي".

* في صفحة "استيراد معرفات وادعاءات موثوقة"، قم بتحميل ملف البيانات الخاص بالتوحيد الفيدرالي لـ _Zaindrive_ الذي قمت بتكوينه في الخطوات السابقة، وحدد خيار "استخدام الشهادة الخاصة بي"، ثم انقر فوق "التالي".

* في صفحة "استعادة الحالة"، قم بتحديد "متاحة" وانقر فوق "التالي".

* في صفحة "العرض"، قم بمراجعة الإعدادات وانقر فوق "إنشاء".

* في صفحة "استعد ثقة واردة"، انقر فوق "مهايئة الآن".

* في نافذة "محرر المحتوى المدعوم"، قم بتحديد خيار "اتبع الموقع إلى URL معين (الموقع المدعوم)" وأدخل عنوان URL لتسجيل الدخول إلى _Zaindrive_، مثل "https://example.com/accounts/saml/login/"، ثم انقر فوق "موافق".

* في صفحة "التكوين"، انقر فوق "إكمال".

* في نافذة "معالج إعداد الثقة الواردة"، انقر فوق "إغلاق".

**المقبل**، تحتاج إلى تكوين تطبيق _Zaindrive_ لاستخدام _AD FS_ كموفر الهوية:

* افتح ملف `ccnet.conf` في مجلد الإعدادات الرئيسي لـ _Zaindrive_.

* في قسم `[SAML]`، قم بتعديل القيم التالية:

```ini
...
[SAML]
ENABLED = True
SSO = True
SIGN_REQUEST = True
SIGN_ASSERTION = False
SIGN_RESPONSE = False
ENTITY_ID = https://example.com/accounts/saml/metadata/
NAME_ID_FORMAT = urn:oasis:names:tc:SAML:2.0:nameid-format:transient
LOGIN_URL = https://example.com/accounts/saml/login/
LOGOUT_URL = https://example.com/accounts/saml/logout/
ASSERTION_CONSUMER_SERVICE_URL = https://example.com/accounts/saml/acs/
```

* قم بتحم

يل ملف الشهادة العامة `adfs-public.cer` الذي قمت بتنزيله في الخطوات السابقة.

* قم بتحديث المفتاح العام لـ _AD FS_ في ملف `ccnet.conf`:

```ini
...
[LDAP]
...
PUBLIC_KEY = /path/to/adfs-public.cer
...
```

* احفظ التغييرات في ملف `ccnet.conf`.

**ملاحظة:** تأكد من تعديل المسارات في الملف `ccnet.conf` لتتوافق مع المسارات الفعلية لتكوين _Zaindrive_ على نظامك.

**الآن** يجب أن تكون قد قمت بتكوين _Zaindrive_ لاستخدام _AD FS_ كموفر الهوية. يمكنك اختبار الدخول إلى _Zaindrive_ باستخدام واجهة SAML SSO الخاصة بك والتحقق من أن الاتصال يتم بنجاح.
